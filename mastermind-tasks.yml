---
- name: Ask.
  pause:
    prompt: "What is your guess?"
  register: guess

- set_fact:
    __guess: "{{  guess.user_input.split(',') }}"

- name: Verify user input.
  block:
    - assert:
        that: (__guess|length) == 4
        quiet: yes

    - block:
        - assert:
            that:
              - __guess[0] in colours
              - __guess[1] in colours
              - __guess[2] in colours
              - __guess[3] in colours
            quiet: yes

        - include_tasks: bull-or-cow.yml

        - name: Increase turn number.
          set_fact:
            turns: "{{ turns | int + 1 }}"

        - name: Register input.
          set_fact:
            input_history: "{{ input_history + [ __guess ] }}"

        - debug:
            msg: |
              {% for input in input_history %}
              Turn {{ loop.index }}: {% for guess in input %}|{{ guess|center(8) }}{% if loop.last %}|
              {% endif %}{% endfor %}
              {% endfor %}
              ----
              {{ bulls }} bulls and {{ cows }} cows

      rescue:
        - name: Error with colours.
          debug:
            msg: "Sorry, only {{ colours }} are allowed."

  rescue:
    - name: Error with colours.
      debug:
        msg: "Your guess should be structured as four components list separated by comma."

- include_tasks: mastermind-tasks.yml
  when:
    - bulls|int != 4
    - turns|int != maxturns
